name: Deploy Supabase Edge Functions

on:
  push:
    branches: [main, master]
    paths:
      - 'supabase/functions/**'
      - '.github/workflows/deploy-functions.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy All Edge Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy All Edge Functions
        run: |
          echo "üöÄ Deploying all Supabase Edge Functions..."
          echo "üîç Auto-detecting functions in supabase/functions/..."
          
          # PROJECT_REF'i bir kez tanƒ±mla (d√∂ng√º dƒ±≈üƒ±nda)
          PROJECT_REF="${{ secrets.SUPABASE_PROJECT_REF }}"
          if [ -z "$PROJECT_REF" ]; then
            PROJECT_REF="xcvcplwimicylaxghiak"
          fi
          echo "üìå Using project ref: $PROJECT_REF"
          
          # Otomatik olarak supabase/functions/ klas√∂r√ºndeki T√úM fonksiyonlarƒ± bul
          FAILED_FUNCTIONS=()
          SUCCESSFUL_FUNCTIONS=()
          
          # supabase/functions/ klas√∂r√ºndeki t√ºm dizinleri bul
          for fn_dir in supabase/functions/*/; do
            # Dizin adƒ±nƒ± al (√∂rn: "supabase/functions/chat-get-rooms/" -> "chat-get-rooms")
            fn_name=$(basename "$fn_dir")
            
            # index.ts veya deno.json dosyasƒ± var mƒ± kontrol et (ge√ßerli bir Edge Function mƒ±?)
            if [ ! -f "$fn_dir/index.ts" ] && [ ! -f "$fn_dir/index.js" ]; then
              echo "‚ö†Ô∏è  Skipping $fn_name (no index.ts/js found)"
              continue
            fi
            
            echo ""
            echo "üì¶ Deploying function: $fn_name"
            echo "----------------------------------------"
            
            # Her function'ƒ± deploy et (ba≈üarƒ±sƒ±z olsa bile devam et)
            if supabase functions deploy "$fn_name" --project-ref "$PROJECT_REF" --no-verify-jwt; then
              echo "‚úÖ Successfully deployed $fn_name"
              SUCCESSFUL_FUNCTIONS+=("$fn_name")
            else
              DEPLOY_EXIT_CODE=$?
              echo "‚ùå Failed to deploy $fn_name (exit code: $DEPLOY_EXIT_CODE)"
              FAILED_FUNCTIONS+=("$fn_name")
            fi
          done
          
          # Eƒüer hi√ß fonksiyon bulunamadƒ±ysa uyarƒ± ver
          if [ ${#SUCCESSFUL_FUNCTIONS[@]} -eq 0 ] && [ ${#FAILED_FUNCTIONS[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è  No Edge Functions found in supabase/functions/"
            exit 0
          fi
          
          echo ""
          echo "=========================================="
          echo "üìä Deployment Summary"
          echo "=========================================="
          echo "‚úÖ Successful: ${#SUCCESSFUL_FUNCTIONS[@]} functions"
          for fn in "${SUCCESSFUL_FUNCTIONS[@]}"; do
            echo "   - $fn"
          done
          
          if [ ${#FAILED_FUNCTIONS[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå Failed: ${#FAILED_FUNCTIONS[@]} functions"
            for fn in "${FAILED_FUNCTIONS[@]}"; do
              echo "   - $fn"
            done
            echo ""
            echo "‚ö†Ô∏è  Some functions failed to deploy. Check logs above."
            exit 1
          else
            echo ""
            echo "üéâ All functions deployed successfully!"
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: List Deployed Functions
        run: |
          echo "üìã Listing all deployed functions:"
          PROJECT_REF="${{ secrets.SUPABASE_PROJECT_REF }}"
          if [ -z "$PROJECT_REF" ]; then
            PROJECT_REF="xcvcplwimicylaxghiak"
          fi
          supabase functions list --project-ref "$PROJECT_REF" || echo "‚ö†Ô∏è  Could not list functions (non-critical)"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
